<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Consistency: There and Back Again · My personal space
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Alex Simkin">
<meta name="description" content="
  What is Consistency token?
  
    
    Link to heading
  

A consistency token represents the state of a resource or entity at a given point in time. It is opaque to consumers, returned in the ETag header by data modifying APIs. Consumers may cache some of these tokens in a request-local or short-term cache when coordinating a number of calls to control the consistency they require via a custom Event-Stream-State request header(s) with the following format (as per standard RFC definition):">
<meta name="keywords" content="blog,developer,personal">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Consistency: There and Back Again">
  <meta name="twitter:description" content="What is Consistency token? Link to heading A consistency token represents the state of a resource or entity at a given point in time. It is opaque to consumers, returned in the ETag header by data modifying APIs. Consumers may cache some of these tokens in a request-local or short-term cache when coordinating a number of calls to control the consistency they require via a custom Event-Stream-State request header(s) with the following format (as per standard RFC definition):">

<meta property="og:url" content="https://SimY4.github.io/posts/004-consistency-there-and-back-again/">
  <meta property="og:site_name" content="My personal space">
  <meta property="og:title" content="Consistency: There and Back Again">
  <meta property="og:description" content="What is Consistency token? Link to heading A consistency token represents the state of a resource or entity at a given point in time. It is opaque to consumers, returned in the ETag header by data modifying APIs. Consumers may cache some of these tokens in a request-local or short-term cache when coordinating a number of calls to control the consistency they require via a custom Event-Stream-State request header(s) with the following format (as per standard RFC definition):">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-07-18T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-07-18T00:00:00+00:00">
    <meta property="article:tag" content="Fp">
    <meta property="article:tag" content="Java">




<link rel="canonical" href="https://SimY4.github.io/posts/004-consistency-there-and-back-again/">


<link rel="preload" href="https://SimY4.github.io/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://SimY4.github.io/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://SimY4.github.io/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="https://SimY4.github.io/css/coder.min.7763f8bc6341ecf82378e867c285e1549abb063a899be313ccd25dbfcd24fa7d.css" integrity="sha256-d2P4vGNB7PgjeOhnwoXhVJq7BjqJm&#43;MTzNJdv80k&#43;n0=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="https://SimY4.github.io/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="https://SimY4.github.io/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="https://SimY4.github.io/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://SimY4.github.io/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="https://SimY4.github.io/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://SimY4.github.io/images/apple-touch-icon.png">

<link rel="manifest" href="https://SimY4.github.io/site.webmanifest">
<link rel="mask-icon" href="https://SimY4.github.io/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://SimY4.github.io/">
      My personal space
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://SimY4.github.io/about/">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://SimY4.github.io/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://SimY4.github.io/index.xml">RSS</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://SimY4.github.io/posts/004-consistency-there-and-back-again/">
              Consistency: There and Back Again
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2021-07-18T00:00:00Z">
                July 18, 2021
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              9-minute read
            </span>
          </div>
          
          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="https://SimY4.github.io/categories/dev-blog/">Dev-Blog</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="https://SimY4.github.io/tags/fp/">Fp</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://SimY4.github.io/tags/java/">Java</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <h2 id="what-is-consistency-token">
  What is Consistency token?
  <a class="heading-link" href="#what-is-consistency-token">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>A consistency token represents the state of a resource or entity at a given point in time. It is opaque to consumers, returned in the <code>ETag</code> header by data modifying APIs. Consumers may cache some of these tokens in a request-local or short-term cache when coordinating a number of calls to control the consistency they require via a custom <code>Event-Stream-State</code> request header(s) with the following format (as per standard RFC definition):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Event-Stream-State = ( &#34;At-Least&#34; (token)
</span></span><span style="display:flex;"><span>                     | &#34;Check-At-Least&#34; (token)
</span></span><span style="display:flex;"><span>                     )
</span></span></code></pre></div><p><code>At-Least</code> means the underlying data used for the request will be brought up to at least the state denoted by the token. This may incur a delay.</p>
<p><code>Check-At-Least</code> means the state of the underlying data used for the request will be checked against the given token. If it is older than the token, the request will fail.</p>
<p>Multiple tokens can be passed through as per standard HTTP header concatenation such as multiple <code>Event-Stream-State</code> headers.</p>
<p>If the consumer does NOT pass an <code>Event-Stream-State</code> header, the services will use whatever data they currently have cached (which may be slightly behind the latest persisted data due to the eventual consistency nature of the system).</p>
<h2 id="initial-consistency-api-design">
  Initial consistency API design
  <a class="heading-link" href="#initial-consistency-api-design">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Since consistency state was passed around in request headers, we’ve parsed and kept consistency tokens in an implicit threadlocal request context. And because of implicit nature of request context, consistency can be summoned at any point in time into an explicit scope via framework’s utilities. That clears code a lot in places where you don’t care about consistency and allows you to easily access it if you’re calling it from a request scoped thread.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">InitialConsistencyService</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Either<span style="color:#666">&lt;</span>Error,<span style="color:#bbb"> </span>Stuff<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">updateStuff</span>(Stuff<span style="color:#bbb"> </span>stuff);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Either<span style="color:#666">&lt;</span>Error,<span style="color:#bbb"> </span>Optional<span style="color:#666">&lt;</span>Stuff<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">fetchStuff</span>(...);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Either<span style="color:#666">&lt;</span>Error,<span style="color:#bbb"> </span>Stuff<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">readAndWriteStuff</span>(...);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>But in this approach, there’s a major disadvantage - the work with consistency is not transparent. People might not even be aware that consistency is there as a thing to worry about. It’s not the problem in itself until you think of start doing certain things asynchronously. Once you escape the request scoped thread suddenly your consistency state will be lost but you wouldn’t even notice that since everything will continue to work as before.</p>
<p>So we tried to improve that by moving consistency into the light and making work with it explicit.</p>
<h2 id="explicit-consistency-and-why-its-bad">
  Explicit consistency and why it’s bad
  <a class="heading-link" href="#explicit-consistency-and-why-its-bad">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>By making consistency explicit, we meant to start passing it all the way from a request parsing step to a response generation step. Which means that all of our services now need to become aware of it.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">ConsistencyAwareService</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Either<span style="color:#666">&lt;</span>Error,<span style="color:#bbb"> </span>WithConsistency<span style="color:#666">&lt;</span>Stuff<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">updateStuff</span>(Stuff<span style="color:#bbb"> </span>stuff);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Either<span style="color:#666">&lt;</span>Error,<span style="color:#bbb"> </span>Optional<span style="color:#666">&lt;</span>Stuff<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">fetchStuff</span>(...,<span style="color:#bbb"> </span>Consistency<span style="color:#bbb"> </span>consistency);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>Either<span style="color:#666">&lt;</span>Error,<span style="color:#bbb"> </span>WithConsistency<span style="color:#666">&lt;</span>Stuff<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">readAndWriteStuff</span>(...,<span style="color:#bbb"> </span>Consistency<span style="color:#bbb"> </span>consistency);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#555;font-weight:bold">@Value</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">WithConsistency</span><span style="color:#666">&lt;</span>T<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>Consistency<span style="color:#bbb"> </span>consistency;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>T<span style="color:#bbb"> </span>value;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>That solves the problem of consistency being implicit. But suddenly it makes consistency instances passed all over the place! Suddenly the code that was mostly focused on expressing the business relevant logic was bloated with passing, converting and aggregating consistency. It looked like it’s the only thing that code does. Which is not relevant since it’s a technical detail. Here’s the real-life example on how we aggregate consistencies when we process a list of consistency aware operations:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Consistency<span style="color:#bbb"> </span>initial<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>...;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>listOfStuff.<span style="color:#4070a0">stream</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>.<span style="color:#4070a0">map</span>(stuff<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>consistencyAwareService.<span style="color:#4070a0">doReadAndWriteWith</span>(stuff,<span style="color:#bbb"> </span>initial))<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic">// &lt;- this is the only bit here that actually does something other than managing consistency</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>.<span style="color:#4070a0">reduce</span>(Either.<span style="color:#666">&lt;</span>Error,<span style="color:#bbb"> </span>WithConsistency<span style="color:#666">&lt;</span>List<span style="color:#666">&lt;</span>Stuff<span style="color:#666">&gt;&gt;&gt;</span>right(WithConsistency.<span style="color:#4070a0">of</span>(<span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>ArrayList<span style="color:#666">&lt;&gt;</span>(),<span style="color:#bbb"> </span>initial)),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>(acc,<span style="color:#bbb"> </span>maybeStuffWithConsistency)<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>acc.<span style="color:#4070a0">flatMap</span>(withConsistency<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>maybeStuffWithConsistency<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>.<span style="color:#4070a0">map</span>(stuffWithConsistency<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>withConsistency.<span style="color:#4070a0">value</span>.<span style="color:#4070a0">add</span>(stuffWithConsistency.<span style="color:#4070a0">value</span>);<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>WithConsistency.<span style="color:#4070a0">of</span>(withConsistency.<span style="color:#4070a0">value</span>,<span style="color:#bbb"> </span>withConsistency.<span style="color:#4070a0">consistency</span>.<span style="color:#4070a0">append</span>(stuffWithConsistency.<span style="color:#4070a0">consistency</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>})),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>(l,<span style="color:#bbb"> </span>r)<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>l.<span style="color:#4070a0">flatMap</span>(lv<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>r.<span style="color:#4070a0">map</span>(rv<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>lv.<span style="color:#4070a0">value</span>.<span style="color:#4070a0">addAll</span>(rv.<span style="color:#4070a0">value</span>);<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>WithConsistency.<span style="color:#4070a0">of</span>(lv,<span style="color:#bbb"> </span>lv.<span style="color:#4070a0">consistency</span>.<span style="color:#4070a0">append</span>(rv.<span style="color:#4070a0">consistency</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>})));<span style="color:#bbb">
</span></span></span></code></pre></div><p>We can hide certain things behind some common consistency combinator methods but even so, this code is very hard to read and it’s even more painful to write. It emphasises on the things that are purely technical and makes the thing that actually matters (do stuff) barely visible in the code.</p>
<p>To make things even worse this is not even a correct encoding of the original intent. Write API should issue the new consistencies for every write or fail (in which case you get no consistency) - that&rsquo;s encoded in an <code>Either&lt;Error, WithConsistency&lt;T&gt;&gt;</code> type. But what about reads? Reads should revoke consistencies on successful read or return an error with outstanding consistencies that haven&rsquo;t been seen yet. Was that encoded in a type <code>Either&lt;Error, T&gt;</code>? No. Consistency tokens are lost on a first unsuccessful read. We can try to correct this by changing a read return type signature to be <code>Either&lt;WithConsistency&lt;Error&gt;, T&gt;</code> but that will mean that in a complex method scenario where you read and write with consistency your full return type would be <code>Either&lt;WithConsistency&lt;Error&gt;, WithConsistency&lt;T&gt;&gt;</code>.</p>
<h2 id="fp-to-the-rescue">
  FP to the rescue!
  <a class="heading-link" href="#fp-to-the-rescue">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>One thing I decided to do here was since we’re trying to practice an FP (at least to some extent) let&rsquo;s try to find the answers in FP patterns.</p>
<p>First of all, by looking at the last fully encoded type that I came up with we can clearly see that we can change the order or our type arguments to make it simpler:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Either<span style="color:#666">&lt;</span>WithConsistency<span style="color:#666">&lt;</span>Error<span style="color:#666">&gt;</span>,<span style="color:#bbb"> </span>WithConsistency<span style="color:#666">&lt;</span>T<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">readAndWriteStuff</span>(...,<span style="color:#bbb"> </span>Consistency<span style="color:#bbb"> </span>constency)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">// equivalent to</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>WithConsistency<span style="color:#666">&lt;</span>Either<span style="color:#666">&lt;</span>Error,<span style="color:#bbb"> </span>T<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">readAndWriteStuff</span>(...,<span style="color:#bbb"> </span>Consistency<span style="color:#bbb"> </span>constency)<span style="color:#bbb">
</span></span></span></code></pre></div><p>That simplifies things a little but still, we will face the same problem as before: encoding all of the type transformations. Let’s improve that code further. We can move the <code>Consistency</code> argument from the right-hand side to the left and see what that can give us.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>WithConsistency<span style="color:#666">&lt;</span>Either<span style="color:#666">&lt;</span>Error,<span style="color:#bbb"> </span>T<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">readAndWriteStuff</span>(...,<span style="color:#bbb"> </span>Consistency<span style="color:#bbb"> </span>constency)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">// equivalent to</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Function<span style="color:#666">&lt;</span>Consistency,<span style="color:#bbb"> </span>WithConsistency<span style="color:#666">&lt;</span>Either<span style="color:#666">&lt;</span>Error,<span style="color:#bbb"> </span>T<span style="color:#666">&gt;&gt;&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">readAndWriteStuff</span>(...)<span style="color:#bbb">
</span></span></span></code></pre></div><p>From the looks of that signature, we can notice that this method becomes lazy. Before that, we return an actual value and now we return a function, calling which with initial consistency state you can get a pair latest evaluated consistency as well as calculated value. We can also notice something similar in the shape of that signature… We take consistency and return consistency back associated with some value. That can be encoded as a State monad.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Function<span style="color:#666">&lt;</span>Consistency,<span style="color:#bbb"> </span>WithConsistency<span style="color:#666">&lt;</span>Either<span style="color:#666">&lt;</span>Error,<span style="color:#bbb"> </span>T<span style="color:#666">&gt;&gt;&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">readAndWriteStuff</span>(...)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">// equivalent to</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>State<span style="color:#666">&lt;</span>Consistency,<span style="color:#bbb"> </span>Either<span style="color:#666">&lt;</span>Error,<span style="color:#bbb"> </span>T<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">readAndWriteStuff</span>(...);<span style="color:#bbb">
</span></span></span></code></pre></div><p>And because the state is a monad we can compose lazily evaluated states to create a bigger state transition. That, in the end, is not attached to any thread - you can run that state transition wherever you feel like it. You can pass state evaluator as a value to a different thread as well as initial consistency value.</p>
<p>But still, you&rsquo;ll need two monad transformation calls in order to access the type <code>T</code> which is encoded in this type. If only we can have something like a monad transformer similar to those that alternative JVM languages have… Well, let’s write it ourselves, shall we?</p>
<h2 id="higher-kinds-in-java">
  Higher kinds in Java
  <a class="heading-link" href="#higher-kinds-in-java">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>There’s a <a href="https://medium.com/@johnmcclean/simulating-higher-kinded-types-in-java-b52a18b72c74"  class="external-link" target="_blank" rel="noopener">good article about how we can encode higher-kinded types in Java</a>. Basically we I&rsquo;m going to follow that article in order to encode the state monad and either transformer. I&rsquo;ll assume that we have State already implemented because it&rsquo;s not that interesting. State is a type that wraps an arrow <code>(S) -&gt; (S, A)</code> with flatMap and pure methods that allow you to compose one state with another. To encode the higher kinds in Java, we&rsquo;ll create an interface with two type parameters:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">Kind1</span><span style="color:#666">&lt;</span>WITNESS,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span></code></pre></div><p>The first argument will encode the witness of our current data type and the other will be the argument of that type. Then for our state monad we’ll add a <code>StateKind</code> extending this interface:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">StateKind</span><span style="color:#666">&lt;</span>W<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Witness<span style="color:#666">&lt;</span>S<span style="color:#666">&gt;</span>,<span style="color:#bbb"> </span>S,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Kind1<span style="color:#666">&lt;</span>W,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">Witness</span><span style="color:#666">&lt;</span>S<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">protected</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>State<span style="color:#666">&lt;</span>S,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>delegate;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#06287e">StateKind</span>(State<span style="color:#666">&lt;</span>S,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>delegate)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">delegate</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>delegate;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">   * Transforms state into higher kind.
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">   */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>W<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Witness<span style="color:#666">&lt;</span>S<span style="color:#666">&gt;</span>,<span style="color:#bbb"> </span>S,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>StateKind<span style="color:#666">&lt;</span>W,<span style="color:#bbb"> </span>S,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">of</span>(State<span style="color:#666">&lt;</span>S,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>state)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>StateKind<span style="color:#666">&lt;&gt;</span>(state);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">   * Transforms higher kind into state.
</span></span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic">   */</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>W<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Witness<span style="color:#666">&lt;</span>S<span style="color:#666">&gt;</span>,<span style="color:#bbb"> </span>S,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>State<span style="color:#666">&lt;</span>S,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">narrow</span>(Kind1<span style="color:#666">&lt;</span>W,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>state)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#60a0b0;font-style:italic">// ugly cast but we assume it&#39;s safe because the type witness should only exist for StateKind.</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>((StateKind<span style="color:#666">&lt;</span>W,<span style="color:#bbb"> </span>S,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span>)<span style="color:#bbb"> </span>state).<span style="color:#4070a0">delegate</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>Based on this we can define a state monad instance:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">Monad</span><span style="color:#666">&lt;</span>WITNESS<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#666">&lt;</span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Kind1<span style="color:#666">&lt;</span>WITNESS,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">pure</span>(A<span style="color:#bbb"> </span>a);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#666">&lt;</span>A,<span style="color:#bbb"> </span>B<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Kind1<span style="color:#666">&lt;</span>WITNESS,<span style="color:#bbb"> </span>B<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">flatMap</span>(Kind1<span style="color:#666">&lt;</span>WITNESS,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>kind,<span style="color:#bbb"> </span>Function<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>A,<span style="color:#bbb"> </span><span style="color:#666">?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Kind1<span style="color:#666">&lt;</span>WITNESS,<span style="color:#bbb"> </span>B<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span>fmap);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">default</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>A,<span style="color:#bbb"> </span>B<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Kind1<span style="color:#666">&lt;</span>WITNESS,<span style="color:#bbb"> </span>B<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">map</span>(Kind1<span style="color:#666">&lt;</span>WITNESS,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>kind,<span style="color:#bbb"> </span>Function<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>A,<span style="color:#bbb"> </span><span style="color:#666">?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>B<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>map)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>flatMap(kind,<span style="color:#bbb"> </span>map.<span style="color:#4070a0">andThen</span>(<span style="color:#007020;font-weight:bold">this</span>::pure));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">StateMonad</span><span style="color:#666">&lt;</span>W<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>StateKind.<span style="color:#4070a0">Witness</span><span style="color:#666">&lt;</span>S<span style="color:#666">&gt;</span>,<span style="color:#bbb"> </span>S<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">implements</span><span style="color:#bbb"> </span>Monad<span style="color:#666">&lt;</span>W<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>Kind1<span style="color:#666">&lt;</span>W,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">pure</span>(A<span style="color:#bbb"> </span>a)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>StateKind.<span style="color:#4070a0">of</span>(State.<span style="color:#4070a0">pure</span>(a));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#666">&lt;</span>A,<span style="color:#bbb"> </span>B<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span>Kind1<span style="color:#666">&lt;</span>W,<span style="color:#bbb"> </span>B<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">flatMap</span>(Kind1<span style="color:#666">&lt;</span>W,<span style="color:#bbb"> </span>A<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>kind,<span style="color:#bbb"> </span>Function<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>A,<span style="color:#bbb"> </span><span style="color:#666">?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>Kind1<span style="color:#666">&lt;</span>W,<span style="color:#bbb"> </span>B<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span>fmap)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span>StateKind.<span style="color:#4070a0">of</span>(StateKind.<span style="color:#4070a0">narrow</span>(fa).<span style="color:#4070a0">flatMap</span>(fmap.<span style="color:#4070a0">andThen</span>(StateKind::narrow)));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">ConsistencyState</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>StateKind.<span style="color:#4070a0">Witness</span><span style="color:#666">&lt;</span>Consistency<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>Monad<span style="color:#666">&lt;</span>ConsistencyState<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>MONAD<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>StateMonad<span style="color:#666">&lt;</span>ConsistencyState,<span style="color:#bbb"> </span>Consistency<span style="color:#666">&gt;</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>And having all that we can implement an <code>Either</code> transformer for any monad instance:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">EitherT</span><span style="color:#666">&lt;</span>WITNESS,<span style="color:#bbb"> </span>L,<span style="color:#bbb"> </span>R<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>Monad<span style="color:#666">&lt;</span>WITNESS<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>monad;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">final</span><span style="color:#bbb"> </span>Kind1<span style="color:#666">&lt;</span>WITNESS,<span style="color:#bbb"> </span>Either<span style="color:#666">&lt;</span>L,<span style="color:#bbb"> </span>R<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span>kind;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#06287e">EitherT</span>(Monad<span style="color:#666">&lt;</span>WITNESS<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>monad,<span style="color:#bbb"> </span>Kind1<span style="color:#666">&lt;</span>WITNESS,<span style="color:#bbb"> </span>Either<span style="color:#666">&lt;</span>L,<span style="color:#bbb"> </span>R<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span>kind)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">monad</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>monad;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">this</span>.<span style="color:#4070a0">kind</span><span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>kind;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>WITNESS,<span style="color:#bbb"> </span>L,<span style="color:#bbb"> </span>R<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>EitherT<span style="color:#666">&lt;</span>WITNESS,<span style="color:#bbb"> </span>L,<span style="color:#bbb"> </span>R<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">of</span>(Monad<span style="color:#666">&lt;</span>WITNESS<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>monad,<span style="color:#bbb"> </span>Kind1<span style="color:#666">&lt;</span>WITNESS,<span style="color:#bbb"> </span>Either<span style="color:#666">&lt;</span>L,<span style="color:#bbb"> </span>R<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span>kind)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>EitherT<span style="color:#666">&lt;&gt;</span>(monad,<span style="color:#bbb"> </span>kind);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#007020;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#666">&lt;</span>B<span style="color:#666">&gt;</span><span style="color:#bbb"> </span>EitherT<span style="color:#666">&lt;</span>WITNESS,<span style="color:#bbb"> </span>L,<span style="color:#bbb"> </span>B<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">flatMap</span>(Function<span style="color:#666">&lt;?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">super</span><span style="color:#bbb"> </span>R,<span style="color:#bbb"> </span><span style="color:#666">?</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">extends</span><span style="color:#bbb"> </span>EitherT<span style="color:#666">&lt;</span>WITNESS,<span style="color:#bbb"> </span>L,<span style="color:#bbb"> </span>B<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span>fmap)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#007020;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">new</span><span style="color:#bbb"> </span>EitherT<span style="color:#666">&lt;&gt;</span>(monad,<span style="color:#bbb"> </span>monad.<span style="color:#4070a0">flatMap</span>(kind,<span style="color:#bbb"> </span>either<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>either.<span style="color:#4070a0">fold</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>l<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>monad.<span style="color:#4070a0">pure</span>(Either.<span style="color:#4070a0">left</span>(l)),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>r<span style="color:#bbb"> </span><span style="color:#666">-&gt;</span><span style="color:#bbb"> </span>fmap.<span style="color:#4070a0">apply</span>(r).<span style="color:#4070a0">kind</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>)));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>Having this we can replace our types with <code>EitherT&lt;ConsistencyState, Error, T&gt;</code> and we can work with as if we would work with an <code>Either</code> type directly! But of course, it will do the same dual monad transformation under the curtains. But we don’t care since now it’s hidden from us. So the final Consistency API will look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">interface</span> <span style="color:#0e84b5;font-weight:bold">FpThroughTheRoofService</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>EitherT<span style="color:#666">&lt;</span>ConsistencyState,<span style="color:#bbb"> </span>Error,<span style="color:#bbb"> </span>Stuff<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">updateStuff</span>(Stuff<span style="color:#bbb"> </span>stuff);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>EitherT<span style="color:#666">&lt;</span>ConsistencyState,<span style="color:#bbb"> </span>Error,<span style="color:#bbb"> </span>Optional<span style="color:#666">&lt;</span>Stuff<span style="color:#666">&gt;&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">fetchStuff</span>(...);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>EitherT<span style="color:#666">&lt;</span>ConsistencyState,<span style="color:#bbb"> </span>Error,<span style="color:#bbb"> </span>Stuff<span style="color:#666">&gt;</span><span style="color:#bbb"> </span><span style="color:#06287e">readAndWriteStuff</span>(...);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>So we returned back to where we started. Our API operates the same way as before - consistency is not part of method parameters list but it&rsquo;s encoded within the method&rsquo;s return argument. Which means that we can easily distinguish methods that can change the consistency state and from ones that don&rsquo;t care about consistency. And using the power of <code>EitherT</code> type we can easily mix these APIs together.</p>
<h2 id="conclusions">
  Conclusions
  <a class="heading-link" href="#conclusions">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Of course, I would not expect anyone to use this practice anywhere in their production code. That was an interesting exploratory work that gave me an idea on how we can achieve pretty much the similar effect in Java by decreasing the level of abstraction a little and throwing a few OO design patterns into the mix. But that was fun. I enjoyed doing it and I hope you enjoyed reading this. 😀</p>
<p>Fin</p>

      </div>


      <footer>
        


        <div id="disqus_thread"></div>
<script>
  window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "actinglikecrazy" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
    
    document.addEventListener('themeChanged', function (e) { 
        if (document.readyState == 'complete') {
          DISQUS.reset({ reload: true, config: disqus_config });
        }
    });
</script>
        
        
        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
      2019 -
    
    2025
     Alex Simkin 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="https://SimY4.github.io/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
